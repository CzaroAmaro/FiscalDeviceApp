<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Raport Zbiorczy Urządzeń</title>
    <style>
        @page {
            size: A4 portrait;
            margin: 2cm 1.5cm;
        }
        body { font-family: sans-serif; font-size: 9pt; color: #333; }
        h1 { font-size: 18pt; text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        h2 { font-size: 14pt; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin: 20px 0 10px 0; page-break-after: avoid; }
        h3 { font-size: 11pt; border-bottom: 1px dotted #ddd; padding-bottom: 3px; margin: 15px 0 10px 0; }

        .device-block { page-break-inside: avoid; margin-bottom: 30px; border-top: 3px solid #eee; padding-top: 15px;}
        .device-block:first-of-type { border-top: none; padding-top: 0; }

        .details-table, .history-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .details-table td, .history-table td, .history-table th { padding: 5px; border-bottom: 1px solid #eee; text-align: left; }
        .details-table td:first-child { font-weight: bold; width: 25%; }
        .history-table th { font-weight: bold; background-color: #f7f7f7; border-bottom: 1px solid #ddd; }

        .no-data { color: #888; padding: 10px; text-align: center; }
        .footer { position: fixed; bottom: -1.5cm; left: 0; right: 0; text-align: center; font-size: 8pt; color: #777; }
        .page-number:after { content: "Strona " counter(page); }
    </style>
</head>
<body>
    <div class="footer">
        Wygenerowano: {{ generation_date }} | <span class="page-number"></span>
    </div>

    <h1>Raport Zbiorczy Urządzeń</h1>

    <p>Raport dla firmy: <strong>{{ company_name }}</strong></p>
    <p>Liczba urządzeń w raporcie: <strong>{{ devices|length }}</strong></p>

    <hr style="margin: 20px 0;">

    {% for device in devices %}
        <div class="device-block">
            <h2>{{ device.brand.name }} {{ device.model_name }} ({{ device.unique_number }})</h2>

            <h3>Dane podstawowe</h3>
            <table class="details-table">
                <tr><td>Właściciel:</td><td>{{ device.owner.name }} (NIP: {{ device.owner.nip }})</td></tr>
                <tr><td>Numer Seryjny:</td><td>{{ device.serial_number }}</td></tr>
                <tr><td>Data Sprzedaży:</td><td>{{ device.sale_date|date:"Y-m-d" }}</td></tr>
                <tr><td>Status:</td><td>{{ device.get_status_display }}</td></tr>
            </table>

           {% if params.include_service_history %}
                <h3>Historia Zleceń Serwisowych</h3>
                <table class="history-table">
                    <thead><tr><th>Nr zlecenia</th><th>Tytuł</th><th>Typ</th><th>Data utworzenia</th><th>Data zakończenia</th><th>Wynik</th></tr></thead>
                    <tbody>
                        {% for ticket in device.filtered_tickets %}
                        <tr>
                            <td>{{ ticket.ticket_number }}</td>
                            <td>{{ ticket.title }}</td>
                            <td>{{ ticket.get_ticket_type_display }}</td>
                            <td>{{ ticket.created_at|date:"Y-m-d" }}</td>
                            <td>{{ ticket.completed_at|date:"Y-m-d"|default:"--" }}</td>
                            <td>{{ ticket.get_resolution_display }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="no-data">Brak zarejestrowanych zleceń w wybranym okresie.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}

            {% if params.include_event_log %}
                <h3>Dziennik Zdarzeń (Przeglądy i akcje)</h3>
                <table class="history-table">
                    <thead><tr><th>Data i czas</th><th>Rodzaj akcji</th><th>Opis</th><th>Wykonane przez</th></tr></thead>
                    <tbody>
                        {% for entry in device.history_entries.all %}
                        <tr>
                            <td>{{ entry.event_date|date:"Y-m-d H:i" }}</td>
                            <td>{{ entry.get_action_type_display }}</td>
                            <td>{{ entry.description }}</td>
                            <td>{{ entry.actor.username|default:"System" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="no-data">Brak wpisów w historii.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>
    {% empty %}
        <p class="no-data">Brak urządzeń spełniających wybrane kryteria.</p>
    {% endfor %}
</body>
</html>